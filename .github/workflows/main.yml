name: Build Linux Kernel

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:  # Allow manual triggers
    inputs:
      build_target:
        description: 'Build target (e.g., gki.aarch64, universal3830, arm, x86_64)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - gki.aarch64
          - universal3830
          - arm
          - x86_64

env:
  CCACHE_DIR: /tmp/ccache
  KBUILD_BUILD_USER: github-actions
  KBUILD_BUILD_HOST: github-actions

jobs:
  build:
    runs-on: ubuntu-22.04
    
    # Dynamic matrix generation based on workflow_dispatch input
    strategy:
      matrix:
        target: ${{ fromJSON(github.event.inputs.build_target == 'all' && '["gki.aarch64", "universal3830", "arm", "x86_64"]' || format('["{0}"]', github.event.inputs.build_target)) }}
        include:
          - target: 'gki.aarch64'
            config: 'build.config.gki.aarch64'
            arch: 'arm64'
          - target: 'universal3830'
            config: 'build.config.universal3830'
            arch: 'arm64'
          - target: 'arm'
            config: 'build.config.arm'
            arch: 'arm'
          - target: 'x86_64'
            config: 'build.config.x86_64'
            arch: 'x86_64'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          bc \
          bison \
          flex \
          libssl-dev \
          libelf-dev \
          rsync \
          kmod \
          cpio \
          git \
          python3 \
          python3-pip \
          lz4 \
          lzop \
          gcc-aarch64-linux-gnu \
          gcc-arm-linux-gnueabi \
          ccache \
          libncurses5-dev
        
        sudo ln -sf /usr/bin/python3 /usr/bin/python
        ccache --set-config=cache_dir=$CCACHE_DIR
        ccache --set-config=max_size=2G
    
    - name: Show build information
      run: |
        echo "Building target: ${{ matrix.target }}"
        echo "Using config: ${{ matrix.config }}"
        echo "Architecture: ${{ matrix.arch }}"
        echo "Event type: ${{ github.event_name }}"
        
        if [ -f "Makefile" ]; then
          echo "Kernel version:"
          head -5 Makefile | grep -E '^VERSION|^PATCHLEVEL|^SUBLEVEL'
        fi
    
    - name: Set up cross-compilation environment
      run: |
        export ARCH=${{ matrix.arch }}
        
        if [ "$ARCH" = "arm64" ]; then
          echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "CC=ccache aarch64-linux-gnu-gcc" >> $GITHUB_ENV
        elif [ "$ARCH" = "arm" ]; then
          echo "CROSS_COMPILE=arm-linux-gnueabi-" >> $GITHUB_ENV
          echo "CC=ccache arm-linux-gnueabi-gcc" >> $GITHUB_ENV
        else
          echo "CC=ccache gcc" >> $GITHUB_ENV
        fi
        
        echo "ARCH=$ARCH" >> $GITHUB_ENV
    
    - name: Build kernel
      timeout-minutes: 60
      run: |
        set -e
        
        echo "Starting build for ${{ matrix.target }}..."
        
        # Check for build script first
        if [ -f "build_kernel.sh" ]; then
          echo "Using build_kernel.sh..."
          chmod +x build_kernel.sh
          
          # Check if script expects config parameter
          if ./build_kernel.sh --help 2>/dev/null | grep -qi "config"; then
            ./build_kernel.sh --config ${{ matrix.config }}
          else
            # Try with environment variable
            BUILD_CONFIG=${{ matrix.config }} ./build_kernel.sh
          fi
        else
          echo "Using manual build process..."
          
          # Create build directory
          BUILD_DIR="build_${{ matrix.target }}"
          mkdir -p $BUILD_DIR
          
          # Set up environment
          export ARCH=${{ matrix.arch }}
          if [ "$ARCH" = "arm64" ]; then
            export CROSS_COMPILE=aarch64-linux-gnu-
          elif [ "$ARCH" = "arm" ]; then
            export CROSS_COMPILE=arm-linux-gnueabi-
          fi
          
          # Try to find or create config
          if [ -f "${{ matrix.config }}" ]; then
            echo "Found build config: ${{ matrix.config }}"
            # Check if it contains CONFIG_* lines
            if grep -q "^CONFIG_" "${{ matrix.config }}"; then
              grep "^CONFIG_" "${{ matrix.config }}" > $BUILD_DIR/.config
              echo "Extracted config from build.config file"
              make O=$BUILD_DIR olddefconfig
            else
              echo "No CONFIG_* lines found, trying to use as make target"
              make O=$BUILD_DIR ${{ matrix.config }}
            fi
          else
            echo "Config file not found, trying defconfig..."
            make O=$BUILD_DIR defconfig
          fi
          
          # Build the kernel
          echo "Building with $(nproc) threads..."
          make O=$BUILD_DIR -j$(nproc)
          
          # Verify build artifacts
          echo "Checking for build artifacts..."
          if [ "$ARCH" = "arm64" ]; then
            if [ -f "$BUILD_DIR/arch/$ARCH/boot/Image" ]; then
              echo "✓ Found Image: $BUILD_DIR/arch/$ARCH/boot/Image"
              ls -lh "$BUILD_DIR/arch/$ARCH/boot/Image"
            fi
            if [ -f "$BUILD_DIR/arch/$ARCH/boot/Image.gz" ]; then
              echo "✓ Found Image.gz"
            fi
          elif [ "$ARCH" = "arm" ]; then
            if [ -f "$BUILD_DIR/arch/$ARCH/boot/zImage" ]; then
              echo "✓ Found zImage"
              ls -lh "$BUILD_DIR/arch/$ARCH/boot/zImage"
            fi
          fi
          
          if [ -f "$BUILD_DIR/vmlinux" ]; then
            echo "✓ Found vmlinux"
            ls -lh "$BUILD_DIR/vmlinux"
          fi
        fi
        
        ccache --show-stats
    
    - name: Archive build artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-${{ matrix.target }}
        path: |
          build_${{ matrix.target }}/
        retention-days: 7
        if-no-files-found: warn
    
    - name: Archive config files
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: configs-${{ matrix.target }}
        path: |
          ${{ matrix.config }}
          build_${{ matrix.target }}/.config
        retention-days: 30

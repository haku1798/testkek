name: Build Samsung A135F Kernel with SukiSU

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  KERNEL_NAME: a13x
  ARCH: arm64
  SUBARCH: arm64
  CONFIG: exynos850_defconfig
  TOOLCHAIN_VERSION: gcc-12
  JOBS: 4

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    # Step 1: Checkout kernel source
    - name: Checkout Kernel Source
      uses: actions/checkout@v4
      with:
        path: kernel
        
    # Step 2: Check kernel version
    - name: Check Kernel Version
      id: check-kernel
      run: |
        cd kernel
        
        # Extract kernel version from Makefile
        VERSION=$(grep '^VERSION =' Makefile | head -1 | awk '{print $3}')
        PATCHLEVEL=$(grep '^PATCHLEVEL =' Makefile | head -1 | awk '{print $3}')
        SUBLEVEL=$(grep '^SUBLEVEL =' Makefile | head -1 | awk '{print $3}')
        EXTRAVERSION=$(grep '^EXTRAVERSION =' Makefile | head -1 | awk '{print $3}')
        
        KERNEL_VERSION="${VERSION}.${PATCHLEVEL}.${SUBLEVEL}${EXTRAVERSION}"
        echo "Kernel Version: $KERNEL_VERSION"
        echo "version=$KERNEL_VERSION" >> $GITHUB_OUTPUT
        echo "major=$VERSION" >> $GITHUB_OUTPUT
        echo "patchlevel=$PATCHLEVEL" >> $GITHUB_OUTPUT
        
    # Step 3: Setup environment
    - name: Setup Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git ccache build-essential zip curl \
          libssl-dev libelf-dev libncurses-dev \
          rsync cpio unzip kmod gcc make flex bison \
          python3 python3-pip bc lz4 lzop xxd wget \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi
        
    # Step 4: Fix script permissions
    - name: Fix Kernel Script Permissions
      run: |
        cd kernel
        echo "Fixing script permissions..."
        chmod +x scripts/*.sh 2>/dev/null || true
        find . -name "*.sh" -type f -exec chmod +x {} \; 2>/dev/null || true
        
    # Step 5: Install SukiSU - This is the step you were trying to add
    - name: Install SukiSU (Built-in Branch)
      run: |
        cd kernel
        
        echo "Installing SukiSU (builtin branch) using setup script..."
        
        # Remove any previous KernelSU/SukiSU attempts
        rm -rf KernelSU SukiSU kernelsu
        
        # Use the official setup script for SukiSU-Ultra
        curl -LSs 'https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh' | bash -s builtin
        
        # Check if the setup script created what we need
        echo "Checking created files..."
        if [ -L "KernelSU" ] || [ -d "KernelSU" ]; then
          echo "✅ SukiSU setup script completed successfully"
          echo "KernelSU points to: $(readlink -f KernelSU 2>/dev/null || echo 'KernelSU directory')"
        else
          echo "⚠️ Setup script may not have created expected structure"
          echo "Current directory contents:"
          ls -la | grep -i suki || ls -la | grep -i kernelsu || echo "No SukiSU/KernelSU files visible"
          
          # Try to find what was created
          echo "Looking for any SukiSU related files..."
          find . -type d -name "*suki*" -o -name "*kernelsu*" 2>/dev/null | head -10
        fi
        
    # Step 6: Configure kernel with SukiSU
    - name: Configure Kernel with SukiSU
      run: |
        cd kernel
        
        export ARCH=${{ env.ARCH }}
        export SUBARCH=${{ env.SUBARCH }}
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
        
        # Create output directory and generate base .config
        mkdir -p out
        make O=out ${{ env.CONFIG }}
        
        echo "Configuring for SukiSU (built-in module)..."
        
        # Check if SukiSU setup script already modified the config
        # If not, we'll add the necessary configs
        if ! grep -q "CONFIG_SUKISU" out/.config 2>/dev/null; then
          echo "Adding SukiSU configuration manually..."
          
          # 1. Enable absolute prerequisites
          echo "CONFIG_KPROBES=y" >> out/.config
          echo "CONFIG_HAVE_KPROBES=y" >> out/.config
          echo "CONFIG_KPROBE_EVENTS=y" >> out/.config
          echo "CONFIG_OVERLAY_FS=y" >> out/.config
          
          # 2. Enable module support
          echo "CONFIG_MODULES=y" >> out/.config
          echo "CONFIG_MODULE_UNLOAD=y" >> out/.config
          
          # 3. Configure SukiSU for built-in
          echo "CONFIG_SUKISU=y" >> out/.config
          echo "CONFIG_SUKISU_BUILTIN=y" >> out/.config
        else
          echo "SukiSU configuration already present, ensuring built-in..."
          # Ensure it's set to built-in (y) not module (m)
          sed -i 's/CONFIG_SUKISU=m/CONFIG_SUKISU=y/g' out/.config 2>/dev/null
          echo "CONFIG_SUKISU_BUILTIN=y" >> out/.config
        fi
        
        # 4. Update the config with new options
        make O=out olddefconfig
        
        echo "Kernel configuration for SukiSU complete."
        echo "Relevant configs:"
        grep -E "CONFIG_SUKISU|CONFIG_MODULES|CONFIG_KPROBES|CONFIG_OVERLAY_FS" out/.config || echo "No SukiSU configs found"
        
    # Step 7: Build kernel
    - name: Build Kernel
      run: |
        cd kernel
        
        export ARCH=${{ env.ARCH }}
        export SUBARCH=${{ env.SUBARCH }}
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
        
        echo "Starting kernel build with GCC..."
        echo "Using toolchain: $(aarch64-linux-gnu-gcc --version | head -n1)"
        
        # Build the kernel with GCC (Samsung kernels usually build with GCC)
        make -j${{ env.JOBS }} O=out
        
        echo "Kernel build completed!"
        
    # Step 8: Build modules
    - name: Build Kernel Modules
      run: |
        cd kernel
        
        export ARCH=${{ env.ARCH }}
        export SUBARCH=${{ env.SUBARCH }}
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
        
        echo "Building kernel modules..."
        make -j${{ env.JOBS }} O=out modules
        
    # Step 9: Verify build
    - name: Verify SukiSU Integration
      run: |
        cd kernel
        
        echo "Verifying build..."
        if [ -f "out/arch/arm64/boot/Image" ] || [ -f "out/arch/arm64/boot/Image.gz" ]; then
          echo "✅ Kernel image created"
        else
          echo "❌ No kernel image found!"
        fi
        
        if grep -q "CONFIG_SUKISU=y" out/.config 2>/dev/null; then
          echo "✅ SukiSU enabled in config"
        fi
        
    # Step 10: Package kernel
    - name: Package Kernel
      run: |
        cd kernel
        
        KERNEL_VERSION="${{ steps.check-kernel.outputs.version }}"
        mkdir -p kernel_output
        
        # Copy kernel image
        if [ -f "out/arch/arm64/boot/Image" ]; then
          cp out/arch/arm64/boot/Image kernel_output/
        elif [ -f "out/arch/arm64/boot/Image.gz" ]; then
          cp out/arch/arm64/boot/Image.gz kernel_output/
        fi
        
        # Copy modules
        mkdir -p kernel_output/modules
        find out -name "*.ko" -exec cp {} kernel_output/modules/ \; 2>/dev/null || true
        
    # Step 11: Upload artifacts
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-a135f-${{ github.sha }}
        path: kernel/kernel_output/

name: Build Samsung A135F Kernel with SukiSU

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  KERNEL_NAME: a13x
  ARCH: arm64
  SUBARCH: arm64
  CONFIG: exynos850_defconfig
  TOOLCHAIN_VERSION: gcc-12
  JOBS: 4

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout Kernel Source
      uses: actions/checkout@v4
      with:
        path: kernel
        
    - name: Check Kernel Version
      id: check-kernel
      run: |
        cd kernel
        VERSION=$(grep '^VERSION =' Makefile | head -1 | awk '{print $3}')
        PATCHLEVEL=$(grep '^PATCHLEVEL =' Makefile | head -1 | awk '{print $3}')
        SUBLEVEL=$(grep '^SUBLEVEL =' Makefile | head -1 | awk '{print $3}')
        EXTRAVERSION=$(grep '^EXTRAVERSION =' Makefile | head -1 | awk '{print $3}')
        KERNEL_VERSION="${VERSION}.${PATCHLEVEL}.${SUBLEVEL}${EXTRAVERSION}"
        echo "Kernel Version: $KERNEL_VERSION"
        echo "version=$KERNEL_VERSION" >> $GITHUB_OUTPUT
        
    - name: Setup Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git ccache build-essential zip curl \
          libssl-dev libelf-dev libncurses-dev \
          rsync cpio unzip kmod gcc make flex bison \
          python3 python3-pip bc lz4 lzop xxd wget \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
          clang-14 llvm-14
        
    - name: Fix Toolchain Issues
      run: |
        cd kernel
        
        echo "Fixing Samsung kernel toolchain issues..."
        
        # Create the expected toolchain directory structure
        mkdir -p toolchain/clang/host/linux-x86/clang-r383902/bin
        
        # Create symlinks for the expected clang toolchain
        ln -sf /usr/bin/clang-14 toolchain/clang/host/linux-x86/clang-r383902/bin/clang
        ln -sf /usr/bin/clang++-14 toolchain/clang/host/linux-x86/clang-r383902/bin/clang++
        
        echo "Created toolchain symlinks"
        
    - name: Fix Kconfig Syntax Errors
      run: |
        cd kernel
        
        echo "Checking for Kconfig syntax errors in drivers/gpu/arm/Kconfig..."
        
        if [ -f "drivers/gpu/arm/Kconfig" ]; then
          echo "Found drivers/gpu/arm/Kconfig, checking lines 25-35..."
          sed -n '25,35p' drivers/gpu/arm/Kconfig
          
          echo "Attempting to fix syntax error around line 28..."
          
          # Make a backup
          cp drivers/gpu/arm/Kconfig drivers/gpu/arm/Kconfig.backup
          
          # The error is likely a missing 'depends on' or incorrect syntax
          # Let's check what's around line 28
          LINE27=$(sed -n '27p' drivers/gpu/arm/Kconfig)
          LINE28=$(sed -n '28p' drivers/gpu/arm/Kconfig)
          LINE29=$(sed -n '29p' drivers/gpu/arm/Kconfig)
          
          echo "Line 27: $LINE27"
          echo "Line 28: $LINE28"
          echo "Line 29: $LINE29"
          
          # Common fix: if there's a 'config' without proper indentation or missing depends
          # Let's comment out the problematic lines and add a working version
          sed -i '27,29d' drivers/gpu/arm/Kconfig
          
          # Insert a fixed version - common Samsung GPU config pattern
          sed -i '26a\config MALI_DEFAULT_ENABLE\n\tbool "Enable default Mali GPU settings"\n\tdepends on GPU_ARM\n\tdefault y\n\thelp\n\t  Enable default Mali GPU settings.' drivers/gpu/arm/Kconfig
          
          echo "Patched drivers/gpu/arm/Kconfig"
        else
          echo "drivers/gpu/arm/Kconfig not found, checking directory..."
          ls -la drivers/gpu/arm/ 2>/dev/null || echo "GPU arm directory not found"
        fi
        
        # Also fix the bv_r38p1 Kconfig warning
        if [ -f "drivers/gpu/arm/bv_r38p1/Kconfig" ]; then
          echo "Fixing MALI_ARBITRATION type redefinition warning..."
          sed -i 's/config MALI_ARBITRATION.*$/config MALI_ARBITRATION\n\tbool "Mali Arbitration Support"/' drivers/gpu/arm/bv_r38p1/Kconfig
        fi
        
    - name: Install SukiSU (Built-in Branch)
      run: |
        cd kernel
        
        echo "Installing SukiSU (builtin branch) using setup script..."
        
        # Remove any previous KernelSU/SukiSU attempts
        rm -rf KernelSU SukiSU kernelsu
        
        # Use the official setup script for SukiSU-Ultra
        curl -LSs 'https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh' | bash -s builtin
        
        # Check if the setup script created what we need
        echo "Checking created files..."
        if [ -L "KernelSU" ] || [ -d "KernelSU" ]; then
          echo "✅ SukiSU setup script completed successfully"
        else
          echo "⚠️ Setup script may not have created expected structure"
          # Continue anyway - maybe it installed differently
        fi
        
    - name: Configure Kernel Step-by-Step
      run: |
        cd kernel
        
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
        export HOSTCC=gcc
        export HOSTCXX=g++
        
        echo "Step 1: Creating output directory..."
        mkdir -p out
        
        echo "Step 2: Running make prepare to set up build system..."
        make O=out prepare
        
        echo "Step 3: Generating .config from defconfig..."
        # First try without any modifications
        if ! make O=out exynos850_defconfig; then
          echo "Defconfig generation failed, trying alternative approach..."
          
          # Try to use an existing config if available
          if [ -f "arch/arm64/configs/exynos850_defconfig" ]; then
            echo "Copying defconfig directly..."
            cp arch/arm64/configs/exynos850_defconfig out/.config
          else
            echo "Creating minimal config manually..."
            # Create a minimal config
            echo "# Minimal Samsung Exynos 850 config" > out/.config
            echo "CONFIG_LOCALVERSION=\"-exynos850\"" >> out/.config
            echo "CONFIG_SYSVIPC=y" >> out/.config
            echo "CONFIG_POSIX_MQUEUE=y" >> out/.config
            echo "CONFIG_ARM64=y" >> out/.config
            echo "CONFIG_ARCH_EXYNOS=y" >> out/.config
            echo "CONFIG_SOC_EXYNOS850=y" >> out/.config
          fi
        fi
        
        echo "Step 4: Enabling SukiSU and required options..."
        {
          echo "CONFIG_KPROBES=y"
          echo "CONFIG_HAVE_KPROBES=y"
          echo "CONFIG_KPROBE_EVENTS=y"
          echo "CONFIG_OVERLAY_FS=y"
          echo "CONFIG_MODULES=y"
          echo "CONFIG_MODULE_UNLOAD=y"
          echo "CONFIG_SUKISU=y"
          echo "CONFIG_SUKISU_BUILTIN=y"
        } >> out/.config
        
        echo "Step 5: Running olddefconfig to resolve dependencies..."
        make O=out olddefconfig || {
          echo "olddefconfig failed, trying to fix config..."
          # Remove problematic options
          sed -i '/CONFIG_ARM/d' out/.config
          sed -i '/CONFIG_ARCH/d' out/.config
          echo "CONFIG_ARM64=y" >> out/.config
          echo "CONFIG_ARCH_EXYNOS=y" >> out/.config
          make O=out olddefconfig
        }
        
        echo "Configuration complete. Final config check:"
        grep -E "CONFIG_SUKISU|CONFIG_MODULES|CONFIG_KPROBES|CONFIG_OVERLAY_FS" out/.config || echo "No SukiSU configs found"
        
    - name: Build Kernel with Debug Output
      run: |
        cd kernel
        
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
        export HOSTCC=gcc
        export HOSTCXX=g++
        
        echo "Starting kernel build..."
        
        # First try a simple build of just the kernel image
        echo "Building Image target only..."
        make -j${{ env.JOBS }} O=out Image 2>&1 | tee build_image.log || {
          echo "Image build failed, showing errors:"
          tail -50 build_image.log
          echo "Trying to build vmlinux instead..."
          make -j${{ env.JOBS }} O=out vmlinux 2>&1 | tee build_vmlinux.log
        }
        
        echo "Build attempt completed"
        
    - name: Check Build Output
      run: |
        cd kernel
        
        echo "Checking for build output..."
        
        # Look for any kernel image files
        echo "Files in out/arch/arm64/boot/:"
        ls -la out/arch/arm64/boot/ 2>/dev/null || {
          echo "No output directory, checking for other build artifacts..."
          find out -name "*.o" -type f | head -5
          find out -name "vmlinux" -type f
        }
        
        # Check if vmlinux was built
        if [ -f "out/vmlinux" ]; then
          echo "✅ vmlinux built successfully"
          # Try to generate Image from vmlinux
          aarch64-linux-gnu-objcopy -O binary -R .note -R .comment -S out/vmlinux out/arch/arm64/boot/Image 2>/dev/null && \
            echo "Generated Image from vmlinux"
        fi
        
    - name: Package Kernel
      run: |
        cd kernel
        
        KERNEL_VERSION="${{ steps.check-kernel.outputs.version }}"
        mkdir -p kernel_output
        
        echo "Packaging build artifacts..."
        
        # Copy whatever we have
        if [ -f "out/arch/arm64/boot/Image" ]; then
          cp out/arch/arm64/boot/Image kernel_output/
          echo "✅ Copied kernel Image"
        elif [ -f "out/vmlinux" ]; then
          cp out/vmlinux kernel_output/
          echo "✅ Copied vmlinux"
        fi
        
        # Try to find and copy modules
        find out -name "*.ko" -exec cp {} kernel_output/ 2>/dev/null \; || true
        
        echo "Package contents:"
        ls -la kernel_output/
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-a135f-${{ github.sha }}
        path: kernel/kernel_output/

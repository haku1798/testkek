name: Build Kernel with KernelSU Next (Stable)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  KERNEL_NAME: a13x
  ARCH: arm64
  SUBARCH: arm64
  CONFIG: exynos850_defconfig
  TOOLCHAIN_VERSION: gcc-12
  JOBS: 4
  KERNELSU_BRANCH: stable

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout Kernel Source
      uses: actions/checkout@v4
      with:
        path: kernel
        
    - name: Check Kernel Version and GKI Status
      id: check-kernel
      run: |
        cd kernel
        
        # Extract kernel version from Makefile
        VERSION=$(grep '^VERSION =' Makefile | head -1 | awk '{print $3}')
        PATCHLEVEL=$(grep '^PATCHLEVEL =' Makefile | head -1 | awk '{print $3}')
        SUBLEVEL=$(grep '^SUBLEVEL =' Makefile | head -1 | awk '{print $3}')
        EXTRAVERSION=$(grep '^EXTRAVERSION =' Makefile | head -1 | awk '{print $3}')
        
        KERNEL_VERSION="${VERSION}.${PATCHLEVEL}.${SUBLEVEL}${EXTRAVERSION}"
        echo "Kernel Version: $KERNEL_VERSION"
        echo "version=$KERNEL_VERSION" >> $GITHUB_OUTPUT
        echo "major=$VERSION" >> $GITHUB_OUTPUT
        echo "patchlevel=$PATCHLEVEL" >> $GITHUB_OUTPUT
        
        # Check if this is a GKI kernel
        echo "Checking for GKI configuration..."
        
        # Method 1: Check config file
        if [ -f "arch/arm64/configs/${{ env.CONFIG }}" ]; then
          if grep -q "CONFIG_ANDROID_ABI" arch/arm64/configs/${{ env.CONFIG }}; then
            IS_GKI="true"
            echo "Found CONFIG_ANDROID_ABI - This is a GKI kernel"
          elif grep -q "CONFIG_ANDROID_GKI" arch/arm64/configs/${{ env.CONFIG }}; then
            IS_GKI="true"
            echo "Found CONFIG_ANDROID_GKI - This is a GKI kernel"
          elif grep -q "GKI" arch/arm64/configs/${{ env.CONFIG }}; then
            IS_GKI="true"
            echo "Found GKI references in config - This is likely a GKI kernel"
          else
            IS_GKI="false"
            echo "No GKI indicators found - This is NOT a GKI kernel"
          fi
        else
          IS_GKI="false"
          echo "Config file not found, assuming non-GKI"
        fi
        
        # Method 2: Check kernel version range for GKI 1.0
        if [ "$VERSION" -eq 4 ] && [ "$PATCHLEVEL" -ge 19 ] && [ "$PATCHLEVEL" -le 20 ]; then
          GKI_VERSION="1.0"
          echo "Kernel $KERNEL_VERSION is in GKI 1.0 range (4.19-4.20)"
        elif [ "$VERSION" -eq 5 ] && [ "$PATCHLEVEL" -le 4 ]; then
          GKI_VERSION="1.0"
          echo "Kernel $KERNEL_VERSION is in GKI 1.0 range (5.0-5.4)"
        elif [ "$VERSION" -eq 5 ] && [ "$PATCHLEVEL" -ge 10 ]; then
          GKI_VERSION="2.0"
          echo "Kernel $KERNEL_VERSION is likely GKI 2.0+"
        else
          GKI_VERSION="unknown"
        fi
        
        echo "is_gki=$IS_GKI" >> $GITHUB_OUTPUT
        echo "gki_version=$GKI_VERSION" >> $GITHUB_OUTPUT
        
        # Determine KernelSU build method
        if [ "$IS_GKI" = "true" ] || [ "$GKI_VERSION" = "1.0" ]; then
          KSU_BUILD_METHOD="builtin"
          echo "KernelSU driver will be built-in (required for GKI kernels)"
        else
          KSU_BUILD_METHOD="module"
          echo "KernelSU driver will be built as module"
        fi
        
        echo "ksu_build_method=$KSU_BUILD_METHOD" >> $GITHUB_OUTPUT
        
    - name: Setup Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git ccache automake flex lzop bison \
          gperf build-essential zip curl zlib1g-dev \
          g++-multilib libxml2-utils bzip2 libbz2-dev \
          libbz2-1.0 libghc-bzlib-dev squashfs-tools \
          pngcrush schedtool dpkg-dev liblz4-tool \
          make optipng maven libssl-dev pwgen libswitch-perl \
          patchelf bc libstdc++6 libncurses5 wget \
          python3 python3-pip python3-dev libffi-dev \
          libxml2-dev libxslt1-dev libjpeg8-dev openjdk-11-jdk \
          libtinfo5 libelf-dev libncurses-dev \
          rsync cpio unzip kmod
          
    - name: Install Toolchain
      run: |
        echo "Installing GCC cross-compilers for ARM64..."
        
        # Install GCC toolchain from Ubuntu repositories (most reliable)
        sudo apt-get install -y \
          gcc-12-aarch64-linux-gnu \
          gcc-12-arm-linux-gnueabi \
          g++-12-aarch64-linux-gnu \
          g++-12-arm-linux-gnueabi \
          clang-14 lld-14 llvm-14
        
        # Create symlinks for compatibility
        sudo ln -sf /usr/bin/aarch64-linux-gnu-gcc-12 /usr/bin/aarch64-linux-gnu-gcc
        sudo ln -sf /usr/bin/arm-linux-gnueabi-gcc-12 /usr/bin/arm-linux-gnueabi-gcc
        sudo ln -sf /usr/bin/aarch64-linux-gnu-g++-12 /usr/bin/aarch64-linux-gnu-g++
        sudo ln -sf /usr/bin/arm-linux-gnueabi-g++-12 /usr/bin/arm-linux-gnueabi-g++
        
        # Create symlinks for clang
        sudo ln -sf /usr/bin/clang-14 /usr/bin/clang
        sudo ln -sf /usr/bin/clang++-14 /usr/bin/clang++
        sudo ln -sf /usr/bin/ld.lld-14 /usr/bin/ld.lld
        sudo ln -sf /usr/bin/llvm-ar-14 /usr/bin/llvm-ar
        sudo ln -sf /usr/bin/llvm-nm-14 /usr/bin/llvm-nm
        sudo ln -sf /usr/bin/llvm-objcopy-14 /usr/bin/llvm-objcopy
        sudo ln -sf /usr/bin/llvm-objdump-14 /usr/bin/llvm-objdump
        sudo ln -sf /usr/bin/llvm-strip-14 /usr/bin/llvm-strip
        
        echo "Toolchain installed successfully!"
        echo "GCC version: $(aarch64-linux-gnu-gcc --version | head -n1)"
        echo "Clang version: $(clang --version | head -n1)"
        
    - name: Set up CCache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: kernel-ksu-build-${{ env.KERNEL_NAME }}
        max-size: 500M
        
    - name: Install KernelSU Next (Stable)
      run: |
        cd kernel
        
        # Install KernelSU Next using the official setup script
        echo "Installing KernelSU Next (stable branch)..."
        
        # Run the KernelSU setup script
        curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -s ${{ env.KERNELSU_BRANCH }}
        
        # The setup script should have created a symlink
        echo "Checking what was created..."
        echo "Current directory contents:"
        ls -la
        
        # Check if KernelSU symlink was created
        if [ -L "KernelSU" ]; then
          echo "✅ KernelSU symlink created successfully"
          echo "KernelSU symlink points to: $(readlink -f KernelSU)"
          
          # Check if the target exists
          if [ -d "$(readlink -f KernelSU)" ]; then
            echo "✅ KernelSU target directory exists"
          else
            echo "⚠️ KernelSU symlink target doesn't exist"
            # Try to create it manually
            if [ -d "KernelSU-Next/kernel" ]; then
              echo "Creating KernelSU symlink manually..."
              rm -f KernelSU
              ln -s KernelSU-Next/kernel KernelSU
            fi
          fi
        elif [ -d "KernelSU" ]; then
          echo "✅ KernelSU directory exists (not a symlink)"
        else
          echo "⚠️ KernelSU not found, checking for KernelSU-Next..."
          if [ -d "KernelSU-Next" ]; then
            echo "Found KernelSU-Next directory"
            if [ -d "KernelSU-Next/kernel" ]; then
              echo "Creating KernelSU symlink..."
              ln -s KernelSU-Next/kernel KernelSU
              echo "✅ Created KernelSU symlink"
            else
              echo "⚠️ KernelSU-Next/kernel directory not found"
              # List KernelSU-Next contents
              echo "KernelSU-Next contents:"
              ls -la KernelSU-Next/
            fi
          else
            echo "❌ KernelSU-Next directory not found"
            echo "Trying manual installation..."
            git clone https://github.com/KernelSU-Next/KernelSU-Next.git --depth=1 --branch=stable
            if [ -d "KernelSU-Next/kernel" ]; then
              ln -s KernelSU-Next/kernel KernelSU
              echo "✅ Manual installation successful"
            else
              echo "⚠️ Manual installation failed, continuing without KernelSU"
            fi
          fi
        fi
        
        # Final check
        if [ -e "KernelSU" ]; then
          echo "✅ KernelSU installation completed"
          echo "KernelSU location: $(readlink -f KernelSU 2>/dev/null || echo KernelSU)"
        else
          echo "⚠️ KernelSU not found, will build without KernelSU support"
        fi
        
    - name: Configure Kernel with KernelSU
      run: |
        cd kernel
        
        # Set up environment variables
        export ARCH=${{ env.ARCH }}
        export SUBARCH=${{ env.SUBARCH }}
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
        export CLANG_TRIPLE=aarch64-linux-gnu-
        
        # Create output directory
        mkdir -p out
        
        # First check if we can build with existing defconfig
        echo "Generating initial configuration..."
        make O=out ${{ env.CONFIG }}
        
        # Enable KernelSU based on kernel version and GKI status
        echo "Configuring KernelSU options..."
        
        # Always enable these for KernelSU
        echo "CONFIG_KPROBES=y" >> out/.config
        echo "CONFIG_HAVE_KPROBES=y" >> out/.config
        echo "CONFIG_KPROBE_EVENTS=y" >> out/.config
        echo "CONFIG_OVERLAY_FS=y" >> out/.config
        
        # Check if KernelSU is installed before enabling
        if [ -e "KernelSU" ]; then
          echo "KernelSU detected, enabling support..."
          echo "CONFIG_KSU=y" >> out/.config
          
          # Check if we need built-in driver for GKI 1.0 kernels
          if [ "${{ steps.check-kernel.outputs.ksu_build_method }}" = "builtin" ]; then
            echo "CONFIG_KSU_BUILTIN=y" >> out/.config
            echo "Enabled built-in KernelSU driver for GKI kernel"
          else
            echo "CONFIG_KSU_MODULE=y" >> out/.config
            echo "KernelSU will be built as module"
          fi
        else
          echo "⚠️ KernelSU not found, building without KernelSU support"
        fi
        
        # Update config with new options
        make O=out olddefconfig
        
        # Display KernelSU-related config
        echo "Kernel configuration:"
        grep -E "CONFIG_KSU|KPROBES|OVERLAY_FS" out/.config || echo "No KernelSU config found"
        
    - name: Build Kernel with KernelSU
      run: |
        cd kernel
        
        # Set environment variables
        export ARCH=${{ env.ARCH }}
        export SUBARCH=${{ env.SUBARCH }}
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
        export CLANG_TRIPLE=aarch64-linux-gnu-
        
        # Build the kernel with Clang (preferred for KernelSU)
        echo "Starting kernel build..."
        
        # First try with Clang
        echo "Attempting build with Clang..."
        if make -j${{ env.JOBS }} O=out \
          CC=clang \
          LD=ld.lld \
          AR=llvm-ar \
          NM=llvm-nm \
          OBJCOPY=llvm-objcopy \
          OBJDUMP=llvm-objdump \
          STRIP=llvm-strip \
          CROSS_COMPILE=aarch64-linux-gnu- \
          CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
          CLANG_TRIPLE=aarch64-linux-gnu- 2>&1 | tee build.log; then
          
          echo "✅ Kernel built successfully with Clang!"
          
        else
          echo "Clang build failed, trying with GCC..."
          
          # If Clang fails, try with GCC
          if make -j${{ env.JOBS }} O=out \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CROSS_COMPILE_ARM32=arm-linux-gnueabi- 2>&1 | tee -a build.log; then
            
            echo "✅ Kernel built successfully with GCC!"
          else
            echo "❌ Both Clang and GCC builds failed!"
            echo "Last 50 lines of build log:"
            tail -50 build.log
            exit 1
          fi
        fi
        
        # Check for KernelSU modules
        echo "Looking for KernelSU modules..."
        find out -name "*ksu*" -o -name "*KSU*" -o -name "*.ko" 2>/dev/null | head -10 || echo "No KernelSU-specific modules found"
        
    - name: Verify KernelSU Integration
      run: |
        cd kernel
        
        echo "Verifying build..."
        
        # Check if kernel image was created
        if [ -f "out/arch/arm64/boot/Image" ] || [ -f "out/arch/arm64/boot/Image.gz" ]; then
          echo "✅ Kernel image created successfully"
        else
          echo "❌ No kernel image found!"
          ls -la out/arch/arm64/boot/ 2>/dev/null || echo "Output directory not found"
        fi
        
        # Check if kernel has KSU support (if enabled)
        if grep -q "CONFIG_KSU=y" out/.config 2>/dev/null; then
          echo "✅ KernelSU enabled in kernel config"
          
          # Check build method
          if grep -q "CONFIG_KSU_BUILTIN=y" out/.config 2>/dev/null; then
            echo "✅ KernelSU driver: Built-in (for GKI)"
          elif grep -q "CONFIG_KSU_MODULE=y" out/.config 2>/dev/null; then
            echo "✅ KernelSU driver: Module"
          fi
        else
          echo "⚠️ KernelSU not enabled in config"
        fi
        
        # Display kernel version info
        echo "Built kernel info:"
        if [ -f "out/include/generated/utsrelease.h" ]; then
          grep UTS_RELEASE out/include/generated/utsrelease.h || true
        fi
        
    - name: Package Kernel Image
      run: |
        cd kernel
        
        KERNEL_VERSION="${{ steps.check-kernel.outputs.version }}"
        BUILD_DATE=$(date +%Y%m%d-%H%M)
        
        mkdir -p kernel_output
        
        # Check what files were generated
        echo "Checking generated files in out/arch/arm64/boot/:"
        ls -la out/arch/arm64/boot/ 2>/dev/null || echo "No output directory found"
        
        # Copy built images
        if [ -f "out/arch/arm64/boot/Image" ]; then
          cp out/arch/arm64/boot/Image kernel_output/Image
          echo "✅ Copied Image"
        elif [ -f "out/arch/arm64/boot/Image.gz" ]; then
          cp out/arch/arm64/boot/Image.gz kernel_output/Image.gz
          echo "✅ Copied Image.gz"
        else
          echo "❌ No kernel image found!"
          # Try to find any kernel image
          find out -name "Image*" -exec cp {} kernel_output/ \; 2>/dev/null || true
        fi
        
        # Copy device tree images if they exist
        [ -f "out/arch/arm64/boot/dtb.img" ] && cp out/arch/arm64/boot/dtb.img kernel_output/ && echo "✅ Copied dtb.img"
        [ -f "out/arch/arm64/boot/dtbo.img" ] && cp out/arch/arm64/boot/dtbo.img kernel_output/ && echo "✅ Copied dtbo.img"
        
        # Copy all kernel modules
        mkdir -p kernel_output/modules
        find out -name "*.ko" -exec cp {} kernel_output/modules/ \; 2>/dev/null || echo "No modules found"
        
        # List modules for debugging
        echo "Modules found:"
        ls -la kernel_output/modules/ 2>/dev/null | head -10 || echo "No modules directory"
        
        # Create info file
        {
          echo "Kernel: ${{ env.KERNEL_NAME }}"
          echo "Version: $KERNEL_VERSION"
          echo "Architecture: ${{ env.ARCH }}"
          echo "Config: ${{ env.CONFIG }}"
          echo "Toolchain: ${{ env.TOOLCHAIN_VERSION }}"
          echo "KernelSU: Next (${{ env.KERNELSU_BRANCH }} branch)"
          echo "Build Method: ${{ steps.check-kernel.outputs.ksu_build_method }}"
          echo "GKI Status: ${{ steps.check-kernel.outputs.is_gki }} (${{ steps.check-kernel.outputs.gki_version }})"
          echo "Build Date: $(date)"
          echo "Git Commit: ${{ github.sha }}"
        } > kernel_output/build-info.txt
        
    - name: Create AnyKernel3 Flashable Zip
      run: |
        cd kernel
        
        KERNEL_VERSION="${{ steps.check-kernel.outputs.version }}"
        SHORT_SHA=${GITHUB_SHA::7}
        
        git clone https://github.com/osm0sis/AnyKernel3.git --depth=1
        
        # Copy kernel image to AnyKernel3
        if [ -f "kernel_output/Image" ]; then
          cp kernel_output/Image AnyKernel3/
          KERNEL_IMAGE="Image"
        elif [ -f "kernel_output/Image.gz" ]; then
          cp kernel_output/Image.gz AnyKernel3/
          KERNEL_IMAGE="Image.gz"
        else
          echo "❌ No kernel image found to package!"
          # Check if we have any image file
          IMAGE_FILE=$(ls kernel_output/Image* 2>/dev/null | head -1)
          if [ -n "$IMAGE_FILE" ]; then
            cp "$IMAGE_FILE" AnyKernel3/
            KERNEL_IMAGE=$(basename "$IMAGE_FILE")
            echo "✅ Copied $KERNEL_IMAGE"
          else
            exit 1
          fi
        fi
        
        # Copy device tree images if they exist
        [ -f "kernel_output/dtb.img" ] && cp kernel_output/dtb.img AnyKernel3/
        [ -f "kernel_output/dtbo.img" ] && cp kernel_output/dtbo.img AnyKernel3/
        
        # Copy modules
        if [ -d "kernel_output/modules" ] && [ "$(ls -A kernel_output/modules)" ]; then
          mkdir -p AnyKernel3/modules
          cp kernel_output/modules/* AnyKernel3/modules/
          echo "✅ Copied modules"
        fi
        
        # Create anykernel.sh script
        cat > AnyKernel3/anykernel.sh << 'AK_EOF'
        #!/system/bin/sh
        # AnyKernel3 Ramdisk Mod Script
        # osm0sis @ xda-developers
        
        ## AnyKernel setup
        # begin properties
        properties() {
        kernel.string=KernelSU-Next-A135F
        do.devicecheck=1
        do.modules=1
        do.systemless=1
        do.cleanup=1
        do.cleanuponabort=0
        device.name1=a13
        device.name2=A135F
        device.name3=a135f
        device.name4=a13x
        }
        
        ## AnyKernel install
        # begin attributes
        attributes() {
        set_perm_recursive 0 0 755 644 $ramdisk/*;
        }
        
        # shell variables
        block=/dev/block/by-name/boot;
        is_slot_device=0;
        ramdisk_compression=auto;
        
        . tools/ak3-core.sh;
        
        ## AnyKernel file attributes
        # set permissions/ownership for included ramdisk files
        set_perm_recursive 0 0 755 644 $ramdisk/*;
        set_perm_recursive 0 0 750 750 $ramdisk/init* $ramdisk/sbin;
        
        # Install KernelSU modules if present
        if [ -d "$home/modules" ]; then
          ui_print "Installing KernelSU modules...";
          mkdir -p /data/adb/modules;
          cp -rf $home/modules/* /data/adb/modules/;
          set_perm_recursive 0 0 755 644 /data/adb/modules/*;
        fi
        
        ui_print "Kernel with KernelSU Next installed successfully!";
        AK_EOF
        
        # Create update-binary
        mkdir -p AnyKernel3/META-INF/com/google/android
        cat > AnyKernel3/META-INF/com/google/android/update-binary << 'UPDATE_EOF'
        #!/sbin/sh
        # AnyKernel3 Update Binary
        
        OUTFD=$2;
        ZIP=$3;
        
        ui_print() {
          echo -e "ui_print $1\nui_print" > /proc/self/fd/$OUTFD;
        }
        
        ui_print "Flashing KernelSU Next kernel...";
        ui_print "Device: Samsung A135F";
        ui_print "Kernel version: $KERNEL_VERSION";
        
        . /tmp/anykernel/tools/ak3-core.sh;
        UPDATE_EOF
        
        chmod +x AnyKernel3/anykernel.sh
        chmod +x AnyKernel3/META-INF/com/google/android/update-binary
        
        # Create zip
        cd AnyKernel3
        ZIP_NAME="KernelSU-Next-A135F-${KERNEL_VERSION}-${SHORT_SHA}.zip"
        zip -r9 "../$ZIP_NAME" * -x .git README.md
        
        echo "Created flashable zip: $ZIP_NAME"
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-${{ env.KERNEL_NAME }}-${{ github.sha }}
        path: |
          kernel/kernel_output/
          kernel/KernelSU-Next-A135F-*.zip
          
    - name: Create Build Summary
      run: |
        echo "## Kernel Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Kernel Version:** \`${{ steps.check-kernel.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**GKI Status:** ${{ steps.check-kernel.outputs.is_gki }}" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.check-kernel.outputs.is_gki }}" = "true" ]; then
          echo "GKI Version: ${{ steps.check-kernel.outputs.gki_version }}" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**KernelSU Integration:**" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: ${{ env.KERNELSU_BRANCH }}" >> $GITHUB_STEP_SUMMARY
        echo "- Build Method: ${{ steps.check-kernel.outputs.ksu_build_method }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Artifacts Generated:**" >> $GITHUB_STEP_SUMMARY
        echo "- Raw kernel images and modules" >> $GITHUB_STEP_SUMMARY
        echo "- Flashable AnyKernel3 zip" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Details:**" >> $GITHUB_STEP_SUMMARY
        echo "- Toolchain: ${{ env.TOOLCHAIN_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- Config: ${{ env.CONFIG }}" >> $GITHUB_STEP_SUMMARY
        echo "- Architecture: ${{ env.ARCH }}" >> $GITHUB_STEP_SUMMARY

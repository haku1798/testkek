name: Build Samsung A135F Kernel with SukiSU

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  KERNEL_NAME: a13x
  ARCH: arm64
  SUBARCH: arm64
  CONFIG: exynos850_defconfig
  TOOLCHAIN_VERSION: gcc-12
  JOBS: 4

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout Kernel Source
      uses: actions/checkout@v4
      with:
        path: kernel
        
    - name: Check Kernel Version
      id: check-kernel
      run: |
        cd kernel
        VERSION=$(grep '^VERSION =' Makefile | head -1 | awk '{print $3}')
        PATCHLEVEL=$(grep '^PATCHLEVEL =' Makefile | head -1 | awk '{print $3}')
        SUBLEVEL=$(grep '^SUBLEVEL =' Makefile | head -1 | awk '{print $3}')
        EXTRAVERSION=$(grep '^EXTRAVERSION =' Makefile | head -1 | awk '{print $3}')
        KERNEL_VERSION="${VERSION}.${PATCHLEVEL}.${SUBLEVEL}${EXTRAVERSION}"
        echo "Kernel Version: $KERNEL_VERSION"
        echo "version=$KERNEL_VERSION" >> $GITHUB_OUTPUT
        
    - name: Setup Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git ccache build-essential zip curl \
          libssl-dev libelf-dev libncurses-dev \
          rsync cpio unzip kmod gcc make flex bison \
          python3 python3-pip bc lz4 lzop xxd wget \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
          clang-14 llvm-14 tree file
        
    - name: FIX ALL SCRIPT PERMISSIONS (Critical Step)
      run: |
        cd kernel
        
        echo "=== FIXING SCRIPT PERMISSIONS ==="
        
        # First, make absolutely EVERY script executable
        echo "1. Making all *.sh files executable..."
        find . -name "*.sh" -type f -exec chmod +x {} \; 2>/dev/null
        
        echo "2. Making scripts directory fully executable..."
        chmod -R +x scripts/ 2>/dev/null
        
        echo "3. Making specific problematic scripts executable..."
        # List of scripts that showed permission denied
        PROBLEMATIC_SCRIPTS="
          scripts/clang-android.sh
          scripts/gcc-version.sh
          scripts/clang-version.sh
          scripts/lld-version.sh
          scripts/gcc-plugin.sh
        "
        
        for script in $PROBLEMATIC_SCRIPTS; do
          if [ -f "$script" ]; then
            echo "  Fixing: $script"
            chmod +x "$script"
            # Also fix potential line endings
            sed -i 's/\r$//' "$script" 2>/dev/null
          else
            echo "  Not found: $script"
          fi
        done
        
        echo "4. Checking/fixing toolchain scripts..."
        if [ -d "toolchain" ]; then
          find toolchain -name "*.sh" -exec chmod +x {} \; 2>/dev/null
        fi
        
        echo "5. Final permission check..."
        ls -la scripts/*.sh 2>/dev/null | head -10
        
    - name: Fix Kconfig Issues
      run: |
        cd kernel
        
        echo "=== FIXING KCONFIG ISSUES ==="
        
        # Backup original files first
        echo "1. Backing up original Kconfig files..."
        cp init/Kconfig init/Kconfig.backup 2>/dev/null || true
        cp drivers/gpu/arm/Kconfig drivers/gpu/arm/Kconfig.backup 2>/dev/null || true
        cp drivers/gpu/arm/bv_r38p1/Kconfig drivers/gpu/arm/bv_r38p1/Kconfig.backup 2>/dev/null || true
        
        echo "2. Checking init/Kconfig syntax errors..."
        if [ -f "init/Kconfig" ]; then
          echo "   Looking at problematic lines in init/Kconfig..."
          sed -n '15,35p' init/Kconfig
          
          # The errors are in GCC/Clang version detection
          # Let's patch the scripts they call first
          echo "   Patching version detection scripts to use system tools..."
          
          # Patch gcc-version.sh to use system gcc
          if [ -f "scripts/gcc-version.sh" ]; then
            echo "   Patching scripts/gcc-version.sh..."
            sed -i 's|\.\./toolchain/clang/host/linux-x86/clang-r383902/bin/clang|/usr/bin/gcc|g' scripts/gcc-version.sh
            sed -i 's|clang|gcc|g' scripts/gcc-version.sh
          fi
          
          # Patch clang-version.sh to use system clang
          if [ -f "scripts/clang-version.sh" ]; then
            echo "   Patching scripts/clang-version.sh..."
            sed -i 's|\.\./toolchain/clang/host/linux-x86/clang-r383902/bin/clang|/usr/bin/clang-14|g' scripts/clang-version.sh
          fi
          
          # Patch lld-version.sh if exists
          if [ -f "scripts/lld-version.sh" ]; then
            echo "   Patching scripts/lld-version.sh..."
            sed -i 's|\.\./toolchain/clang/host/linux-x86/clang-r383902/bin/clang|/usr/bin/ld.lld-14|g' scripts/lld-version.sh 2>/dev/null
          fi
          
          # Patch gcc-plugin.sh
          if [ -f "scripts/gcc-plugin.sh" ]; then
            echo "   Patching scripts/gcc-plugin.sh..."
            sed -i 's|\.\./toolchain/clang/host/linux-x86/clang-r383902/bin/clang|/usr/bin/gcc|g' scripts/gcc-plugin.sh
          fi
        fi
        
        echo "3. Fixing GPU Kconfig issues..."
        # Fix the GPU Kconfig syntax error by simplifying it
        if [ -f "drivers/gpu/arm/Kconfig" ]; then
          echo "   Simplifying drivers/gpu/arm/Kconfig..."
          # Create a minimal working version
          cat > drivers/gpu/arm/Kconfig << 'EOF'
# SPDX-License-Identifier: GPL-2.0-only
#
# ARM GPU configuration
#

menuconfig GPU_ARM
	bool "ARM GPU support"
	depends on ARM || ARM64
	help
	  Say Y here to enable support for ARM GPUs.

if GPU_ARM

config MALI_DEFAULT
	bool "Enable default Mali GPU settings"
	default y
	help
	  Enable default Mali GPU settings.

endif # GPU_ARM
EOF
        fi
        
        echo "4. Fixing MALI_ARBITRATION warning..."
        if [ -f "drivers/gpu/arm/bv_r38p1/Kconfig" ]; then
          # Fix the type redefinition warning
          sed -i 's/^config MALI_ARBITRATION$/# config MALI_ARBITRATION was here/' drivers/gpu/arm/bv_r38p1/Kconfig
          sed -i 's/^config MALI_ARBITRATION\t/# config MALI_ARBITRATION was here/' drivers/gpu/arm/bv_r38p1/Kconfig
        fi
        
        echo "Kconfig fixes applied!"
        
    - name: Install SukiSU (Built-in Branch)
      run: |
        cd kernel
        
        echo "=== INSTALLING SUKISU ==="
        
        # Remove any previous KernelSU/SukiSU attempts
        rm -rf KernelSU SukiSU kernelsu
        
        echo "1. Running SukiSU setup script..."
        curl -LSs 'https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh' | bash -s builtin
        
        echo "2. Checking installation..."
        if [ -L "KernelSU" ] || [ -d "KernelSU" ]; then
          echo "✅ SukiSU installed"
        else
          echo "⚠️ SukiSU not found, continuing anyway..."
        fi
        
    - name: Simple Direct Build Attempt
      run: |
        cd kernel
        
        echo "=== SIMPLE DIRECT BUILD ==="
        
        # Clean environment
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
        
        # Create output directory
        mkdir -p out
        
        echo "1. Creating minimal config manually..."
        
        # Create a bare minimum config that should work
        cat > out/.config << 'EOF'
# Minimal Exynos 850 config
CONFIG_LOCALVERSION="-exynos850-a13x"
CONFIG_SYSVIPC=y
CONFIG_POSIX_MQUEUE=y
CONFIG_AIO=y
CONFIG_ARM64=y
CONFIG_ARCH_EXYNOS=y
CONFIG_SOC_EXYNOS850=y
CONFIG_NR_CPUS=8
CONFIG_HZ_100=y
CONFIG_THUMB2_KERNEL=n
CONFIG_ARM64_PAGE_SHIFT=12
CONFIG_ARM64_CONT_SHIFT=4
CONFIG_ARCH_MMAP_RND_BITS=18
CONFIG_ARCH_MMAP_RND_COMPAT_BITS=11
CONFIG_KPROBES=y
CONFIG_HAVE_KPROBES=y
CONFIG_KPROBE_EVENTS=y
CONFIG_OVERLAY_FS=y
CONFIG_MODULES=y
CONFIG_MODULE_UNLOAD=y
# SukiSU
CONFIG_SUKISU=y
CONFIG_SUKISU_BUILTIN=y
EOF
        
        echo "2. Running olddefconfig to fill in defaults..."
        make O=out olddefconfig 2>&1 | grep -v "warning:" || true
        
        echo "3. Building the kernel Image directly..."
        make -j${{ env.JOBS }} O=out Image 2>&1 | tee build.log || {
          echo "Build failed, checking what we have..."
          tail -100 build.log
        }
        
        echo "4. Checking what was built..."
        ls -la out/arch/arm64/boot/ 2>/dev/null || echo "No arch/arm64/boot directory"
        
    - name: Build Modules if Kernel Built
      run: |
        cd kernel
        
        echo "=== BUILDING MODULES ==="
        
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
        
        # Only build modules if kernel was built
        if [ -f "out/arch/arm64/boot/Image" ] || [ -f "out/vmlinux" ]; then
          echo "Kernel was built, building modules..."
          make -j${{ env.JOBS }} O=out modules 2>&1 | tee modules.log || echo "Module build failed"
        else
          echo "Skipping module build - no kernel found"
        fi
        
    - name: Package Results
      run: |
        cd kernel
        
        echo "=== PACKAGING RESULTS ==="
        
        KERNEL_VERSION="${{ steps.check-kernel.outputs.version }}"
        mkdir -p kernel_output
        
        echo "Looking for build artifacts..."
        
        # Check for various output files
        if [ -f "out/arch/arm64/boot/Image" ]; then
          echo "✅ Found kernel Image"
          cp out/arch/arm64/boot/Image kernel_output/
          file kernel_output/Image
        fi
        
        if [ -f "out/arch/arm64/boot/Image.gz" ]; then
          echo "✅ Found compressed Image.gz"
          cp out/arch/arm64/boot/Image.gz kernel_output/
        fi
        
        if [ -f "out/vmlinux" ]; then
          echo "✅ Found vmlinux"
          cp out/vmlinux kernel_output/
          # Try to create Image from vmlinux
          aarch64-linux-gnu-objcopy -O binary -R .note -R .comment -S out/vmlinux kernel_output/vmlinux.bin 2>/dev/null && \
            echo "Created vmlinux.bin from vmlinux"
        fi
        
        # Copy modules if any
        mkdir -p kernel_output/modules
        find out -name "*.ko" -exec cp {} kernel_output/modules/ \; 2>/dev/null || true
        
        # List what we have
        echo "Final artifacts:"
        ls -la kernel_output/
        
        # Create build info
        {
          echo "Build attempt for Samsung A135F"
          echo "Kernel: $KERNEL_VERSION"
          echo "Date: $(date)"
          echo "Git SHA: ${{ github.sha }}"
          echo ""
          echo "If Image file exists, it may be flashable."
          echo "If only vmlinux exists, more work is needed."
        } > kernel_output/README.txt
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build-attempt-${{ github.sha }}
        path: kernel/kernel_output/
        
    - name: Debug Info
      if: always()
      run: |
        cd kernel
        
        echo "=== DEBUG INFORMATION ==="
        echo "Last 20 lines of build.log:"
        tail -20 build.log 2>/dev/null || echo "No build.log"
        
        echo ""
        echo "Tree structure of out/ directory:"
        tree out/ -L 3 2>/dev/null | head -50 || ls -la out/ 2>/dev/null || echo "No out/ directory"
        
        echo ""
        echo "Script permissions:"
        ls -la scripts/*.sh 2>/dev/null | head -10

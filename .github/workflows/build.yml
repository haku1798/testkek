    - name: Install SukiSU (Built-in Branch)
      run: |
        cd kernel
        
        echo "Installing SukiSU (builtin branch) using setup script..."
        
        # Remove any previous KernelSU/SukiSU attempts
        rm -rf KernelSU SukiSU kernelsu
        
        # Use the official setup script for SukiSU-Ultra
        curl -LSs 'https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh' | bash -s builtin
        
        # Check if the setup script created what we need
        echo "Checking created files..."
        if [ -L "KernelSU" ] || [ -d "KernelSU" ]; then
          echo "✅ SukiSU setup script completed successfully"
          echo "KernelSU points to: $(readlink -f KernelSU 2>/dev/null || echo 'KernelSU directory')"
        else
          echo "⚠️ Setup script may not have created expected structure"
          echo "Current directory contents:"
          ls -la | grep -i suki || ls -la | grep -i kernelsu || echo "No SukiSU/KernelSU files visible"
          
          # Try to find what was created
          echo "Looking for any SukiSU related files..."
          find . -type d -name "*suki*" -o -name "*kernelsu*" 2>/dev/null | head -10
        fi
        
    - name: Configure Kernel with SukiSU
      run: |
        cd kernel
        
        export ARCH=${{ env.ARCH }}
        export SUBARCH=${{ env.SUBARCH }}
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
        
        # Create output directory and generate base .config
        mkdir -p out
        make O=out ${{ env.CONFIG }}
        
        echo "Configuring for SukiSU (built-in module)..."
        
        # Check if SukiSU setup script already modified the config
        # If not, we'll add the necessary configs
        if ! grep -q "CONFIG_SUKISU" out/.config 2>/dev/null; then
          echo "Adding SukiSU configuration manually..."
          
          # 1. Enable absolute prerequisites
          echo "CONFIG_KPROBES=y" >> out/.config
          echo "CONFIG_HAVE_KPROBES=y" >> out/.config
          echo "CONFIG_KPROBE_EVENTS=y" >> out/.config
          echo "CONFIG_OVERLAY_FS=y" >> out/.config
          
          # 2. Enable module support
          echo "CONFIG_MODULES=y" >> out/.config
          echo "CONFIG_MODULE_UNLOAD=y" >> out/.config
          
          # 3. Configure SukiSU for built-in
          echo "CONFIG_SUKISU=y" >> out/.config
          echo "CONFIG_SUKISU_BUILTIN=y" >> out/.config
        else
          echo "SukiSU configuration already present, ensuring built-in..."
          # Ensure it's set to built-in (y) not module (m)
          sed -i 's/CONFIG_SUKISU=m/CONFIG_SUKISU=y/g' out/.config 2>/dev/null
          echo "CONFIG_SUKISU_BUILTIN=y" >> out/.config
        fi
        
        # 4. Update the config with new options
        make O=out olddefconfig
        
        echo "Kernel configuration for SukiSU complete."
        echo "Relevant configs:"
        grep -E "CONFIG_SUKISU|CONFIG_MODULES|CONFIG_KPROBES|CONFIG_OVERLAY_FS" out/.config || echo "No SukiSU configs found"
